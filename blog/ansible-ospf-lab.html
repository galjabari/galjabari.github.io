<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ghannam Aljabari</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="../index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Blog</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container">

    <h5>OSPF Lab with Ansible and Containerlab</h5>
    <p>This guide demonstrates how to deploy and configure an OSPF lab using Ansible and Containerlab.</p>
    <p>The lab uses a 3-router topology with one spine and two leaf routers, all running Arista cEOS. The topology is
      defined in the <code>ospf.clab.yml</code> file:</p>

    <pre>
name: ospf

topology:
  nodes:
    spine:
      kind: arista_ceos
      image: takfa19/ceos:4.32.2F
    leaf1:
      kind: arista_ceos
      image: takfa19/ceos:4.32.2F
    leaf2:
      kind: arista_ceos
      image: takfa19/ceos:4.32.2F
  links:
    - endpoints: ["spine:eth1", "leaf1:eth1"]
    - endpoints: ["spine:eth2", "leaf2:eth1"]
</pre>


    <p>First, deploy the topology with Containerlab.</p>

    <pre>
containerlab deploy -t ospf.clab.yml</pre>

    <p>Then, create Ansible playbooks to configure the network interfaces and set up OSPF on each node.</p>
    <p>Create a playbook (<code>spine.yml</code>) to configure the spine router:</p>
    <pre>
---
- name: Configure Arista cEOS Spine
  hosts: clab-ospf-spine
  vars:
    ansible_connection: network_cli
    ansible_network_os: arista.eos.eos
    ansible_host_key_checking: false
    ansible_become: yes
  gather_facts: false
  tasks:
    - name: Configure Ethernet interfaces
      arista.eos.eos_l3_interfaces:
        config:
          - name: Ethernet1
            ipv4:
              - address: 192.168.1.1/30
          - name: Ethernet2
            ipv4:
              - address: 192.168.1.5/30
          - name: Loopback0
            ipv4:
              - address: 10.10.10.1/32
        state: merged
    - name: Enable Ethernet interfaces
      arista.eos.eos_interfaces:
        config:
          - name: Ethernet1
            enabled: true
            mode: layer3
          - name: Ethernet2
            enabled: true
            mode: layer3
        state: merged
    - name: Enable IP routing
      arista.eos.eos_config:
        lines:
          - ip routing
    - name: Configure OSPF settings
      arista.eos.eos_ospfv2:
        config:
          processes:
            - process_id: 1
              router_id: "10.10.10.1"
              networks:
                - prefix: "10.10.10.1/32"
                  area: "0.0.0.0"
                - prefix: "192.168.1.0/30"
                  area: "0.0.0.0"
                - prefix: "192.168.1.4/30"
                  area: "0.0.0.0"
        state: merged
</pre>

    <p>Create a playbook (<code>leaf1.yml</code>) to configure the first leaf router:</p>
    <pre>
---
- name: Configure Arista cEOS Leaf 1
  hosts: clab-ospf-leaf1
  vars:
    ansible_connection: network_cli
    ansible_network_os: arista.eos.eos
    ansible_host_key_checking: false
    ansible_become: yes
  gather_facts: false
  tasks:
    - name: Configure Ethernet interfaces
      arista.eos.eos_l3_interfaces:
        config:
          - name: Ethernet1
            ipv4:
              - address: 192.168.1.2/30
          - name: Ethernet2
            ipv4:
              - address: 192.168.10.1/24
          - name: Loopback0
            ipv4:
              - address: 10.10.10.2/32
        state: merged
    - name: Enable Ethernet interfaces
      arista.eos.eos_interfaces:
        config:
          - name: Ethernet1
            enabled: true
            mode: layer3
          - name: Ethernet2
            enabled: true
            mode: layer3
        state: merged
    - name: Enable IP routing
      arista.eos.eos_config:
        lines:
          - ip routing
    - name: Configure OSPF settings
      arista.eos.eos_ospfv2:
        config:
          processes:
            - process_id: 1
              router_id: "10.10.10.2"
              networks:
                - prefix: "10.10.10.2/32"
                  area: "0.0.0.0"
                - prefix: "192.168.1.0/30"
                  area: "0.0.0.0"
        state: merged
</pre>

    <p>Create a playbook (<code>leaf2.yml</code>) to configure the second leaf router:</p>
    <pre>
---
- name: Configure Arista cEOS Leaf 2
  hosts: clab-ospf-leaf2
  vars:
    ansible_connection: network_cli
    ansible_network_os: arista.eos.eos
    ansible_host_key_checking: false
    ansible_become: yes
  gather_facts: false
  tasks:
    - name: Configure Ethernet interfaces
      arista.eos.eos_l3_interfaces:
        config:
          - name: Ethernet1
            ipv4:
              - address: 192.168.1.6/30
          - name: Ethernet2
            ipv4:
              - address: 192.168.20.1/24
          - name: Loopback0
            ipv4:
              - address: 10.10.10.3/32
        state: merged
    - name: Enable Ethernet interfaces
      arista.eos.eos_interfaces:
        config:
          - name: Ethernet1
            enabled: true
            mode: layer3
          - name: Ethernet2
            enabled: true
            mode: layer3
        state: merged
    - name: Enable IP routing
      arista.eos.eos_config:
        lines:
          - ip routing
    - name: Configure OSPF settings
      arista.eos.eos_ospfv2:
        config:
          processes:
            - process_id: 1
              router_id: "10.10.10.3"
              networks:
                - prefix: "10.10.10.3/32"
                  area: "0.0.0.0"
                - prefix: "192.168.1.4/30"
                  area: "0.0.0.0"
        state: merged
</pre>
    <p>Next, execute the playbooks for each device:</p>
    <pre>
ansible-playbook -i clab-ospf/ansible-inventory.yml leaf1.yml
ansible-playbook -i clab-ospf/ansible-inventory.yml leaf2.yml
ansible-playbook -i clab-ospf/ansible-inventory.yml spine.yml
</pre>

    <p>You can verify the OSPF routing tables using the following Ansible playbook
      (<code>verify.yml</code>):</p>
    <pre>
---
- name: Show OSPF routing table on Arista cEOS routers
  hosts: arista_ceos
  vars:
    ansible_connection: network_cli
    ansible_network_os: arista.eos.eos
    ansible_host_key_checking: false
  gather_facts: false
  tasks:
    - name: Show OSPF routes
      arista.eos.eos_command:
        commands: 
          - show ip ospf neighbor
          - show ip route ospf
      register: ospf_output

    - name: Display OSPF routes
      ansible.builtin.debug:
        var: ospf_output.stdout_lines
</pre>
    <p>Run the playbook:</p>
    <pre>
ansible-playbook -i clab-ospf/ansible-inventory.yml verify.yml
</pre>
        
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
