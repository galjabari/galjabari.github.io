<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A step-by-step guide on how to configure OpenVPN with RADIUS and LDAP authentication on Ubuntu.">
    <title>Ghannam Aljabari</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Blog</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <h5>OpenVPN with RADIUS and LDAP authentication</h5>
        <p>This guide outlines the configuration of OpenVPN with RADIUS and LDAP authentication. It enables the enforcement of VPN access policies based on LDAP group membership or specific LDAP attributes.</p>
        <p>Before proceeding, ensure you have completed the following guides:</p>
        <p><a href="configure-freeradius-ldap.html" target="_blank">Configure FreeRADIUS with LDAP authentication</a></p>        
        <p><a href="openvpn-ztna.html" target="_blank">OpenVPN with RADIUS for ZTNA</a></p>
        
        <h6>Configure FreeRADIUS for LDAP group membership</h6>
        <p>To create access policies based on LDAP group membership, we need to modify the FreeRADIUS configuration.</p>
        <pre>sudo nano /etc/freeradius/3.0/sites-available/default</pre>
        <p>Inside the configuration file, uncomment the following lines in the <code>authorize</code> section:</p>
        <pre>authorize {
    ...
    ldap
    ...
}</pre>
        <p>Edit the LDAP module configuration file:</p>
        <pre>sudo nano /etc/freeradius/3.0/mods-available/ldap</pre>
        <p>Then, modify the following parameters:</p>
        <pre>filter = '(objectClass=groupOfNames)'
name_attribute = cn
membership_filter = "(|(member=%{control:${..user_dn}})(memberUid=%{%{Stripped-User-Name}:-%{User-Name}}))"</pre>
        
        <p>For example, to restrict VPN access to members of a specific LDAP group (e.g., <code>group1</code>), modify the FreeRADIUS configuration file:</p>
        <pre>sudo nano /etc/freeradius/3.0/sites-available/default</pre>
        <p>Locate the <code>authorize</code> section and add the following policy.</p>
        <pre>if (LDAP-Group == "group1") {
    update reply {
        Reply-Message = "Access Granted"
    }
} else {
    update reply {
        Reply-Message = "Access Denied: Not a member of the VPN group."
    }
    reject
}
</pre>
        <p>To apply the changes, restart the FreeRADIUS service:</p>
        <pre>sudo systemctl restart freeradius.service</pre>
        <p>Test LDAP authentication with group membership using the <code>radtest</code> command.</p>
        <pre>radtest user1 secret localhost 0 testing123</pre>
        <p>You should see a message indicating whether access is granted or denied based on group membership.</p>

        <h6>Configure FreeRADIUS for LDAP attributes</h6>
        <p>We can also create access policies based on specific LDAP attributes. For example, to assign static IP addresses to VPN users, extend the OpenLDAP schema with FreeRADIUS attributes:</p>
        <pre>gunzip -c /usr/share/doc/freeradius/schemas/ldap/openldap/freeradius.ldif.gz > freeradius.ldif<br>sudo ldapadd -Y EXTERNAL -H ldapi:/// -f freeradius.ldif</pre>
        <p>Verify that the schema has been loaded correctly:</p>
        <pre>sudo ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=schema,cn=config</pre>
        <p>Restart the OpenLDAP service to apply the changes:</p>
        <pre>sudo systemctl restart slapd</pre>

        <p>Next, edit the FreeRADIUS LDAP module configuration file:</p>
        <pre>sudo nano /etc/freeradius/3.0/mods-enabled/ldap</pre>
        <p>Add the following line within the <code>update</code> section to map the <code>Framed-IP-Address</code> attribute:</p>
        <pre>update {
  reply:Framed-IP-Address := 'radiusFramedIPAddress'
}</pre>
        <p>Restart the FreeRADIUS service to apply the changes:</p>
        <pre>sudo systemctl restart freeradius.service</pre>
        <p>Now, modify LDAP users to include the <code>radiusFramedIPAddress</code> attribute, which specifies the static IP address assigned to the user upon VPN connection.</p>
        <p>Create a file named <code>user.ldif</code>:</p>
        <pre>nano user.ldif</pre>
        <p>Add the following content to the <code>user1</code> LDAP entry:</p>
        <pre>dn: uid=user1,ou=People,dc=example,dc=com
changetype: modify
add: objectClass
objectClass: radiusprofile
-
add: radiusFramedIPAddress
radiusFramedIPAddress: 10.8.0.100</pre>
        <p>Apply the changes to the LDAP directory:</p>
        <pre>ldapmodify -x -D "cn=admin,dc=example,dc=com" -W -f user.ldif</pre>
        <p>Test LDAP authentication again using the <code>radtest</code> command.</p>
        <pre>radtest user1 secret localhost 0 testing123</pre>
        <p>Now, when <code>user1</code> connects to the VPN, they should be assigned the static IP address.</p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
